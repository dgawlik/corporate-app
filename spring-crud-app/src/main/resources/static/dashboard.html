<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>AwesomeCORP</title>
    <meta name="description" content="Welcome to AwesomeCORP">
    <meta name="author" content="AwesomeCORP">

    <style>
        .hide {
            visibility: hidden;
         }
    </style>

    <script type="text/javascript">
            async function unwrapAlert(response){
                if(!response.ok){
                    let txt = await response.text()
                    swal({
                      title: response.status,
                      text: txt,
                      icon: "error",
                    });
                }
                return response.text();
            }

            function randomChoice(arr) {
              return arr[Math.floor(Math.random() * arr.length)];
            }

            var init = fetch("/api/fill")
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
</head>

<body>
<nav>
    <h6><a href="/logout">Logout</a></h6>
</nav>
<main class="container p-4" id="dashboard-app" class="hide" >
    <h1>{{model.me.firstName}}'s Dashboard</h1>


    <p>Name: {{model.me.firstName}}</p>
    <p>Last name: {{model.me.lastName}}</p>
    <p>Age: {{model.me.age}}</p>
    <p>Salary: {{model.me.salary}}</p>
    <p>Role: {{model.me.role}}</p>
    <br>

    <h3>Your boss</h3>

    <p>{{model.boss.firstName + " " + model.boss.lastName}}</p>
    <br>

    <h3>Your colleagues</h3>
    <table class="table">
        <tbody>
        <tr v-for="c in model.colleagues">
            <td><input v-model="subjectId" name="personId" type="radio" :value="c.id"></td>
            <td>{{c.firstName}}</td>
            <td>{{c.lastName}}</td>
            <td>{{c.role}}</td>
        </tr>
        </tbody>
    </table>
    <input type="text" placeholder="Justification" v-model="initJustification">
    <div class="btn-group" role="group">
        <button v-on:click="initiateCase" :disabled="!subjectId || !initJustification" v-for="a in model.actions.filter(a=> a != 'HIRE')" type="button" class="btn btn-primary">{{a}}</button>
        <button v-on:click="onHire" :disabled="!initJustification" type="button" class="btn btn-primary">HIRE</button>
    </div>
    <br>
    <br>
    <br>

    <h3>Your cases</h3>
    <table class="table">
        <thead>
        <th></th>
        <th class="w-1/6">ID</th>
        <th class="w-1/6">Approved?</th>
        <th class="w-1/6">Done?</th>
        <th class="w-1/6">Justification</th>
        <th class="w-1/6">Contact Person</th>
        </thead>
        <tbody>
        <tr v-for="c in model.myCases">
            <td><input v-model="caseId" name="caseId" type="radio" :value="c.id"></td>
            <td><a :href="`/caseView?caseId=${c.id}`">{{c.id}}</a></td>
            <td>{{c.approved}}</td>
            <td>{{c.done}}</td>
            <td>{{c.justification}}</td>
            <td>{{c.initiatingPerson.firstName + " " + c.initiatingPerson.lastName}}</td>
        </tr>
        </tbody>
    </table>
    <input type="text" v-model="stepJustification" placeholder="Justification">
    <div class="btn-group" role="group">
        <button v-on:click="reject" :disabled="caseButtonDisabled"  type="button" class="btn btn-primary">Reject</button>
        <button v-on:click="approve" :disabled="caseButtonDisabled"  type="button" class="btn btn-primary">Approve</button>
    </div>
</main>
<script>
        (async function init2(){
            const fillResponse = await init
            const fillJson = JSON.parse(await unwrapAlert(fillResponse))

            const bossView = fillJson.colleagues.filter(c => c.id == fillJson.me.parentId)[0] || {}
            fillJson.boss = bossView

            var dashboardApp = new Vue({
              el: '#dashboard-app',
              data: {
                model: fillJson,
                subjectId: null,
                caseId: null,
                initJustification: null,
                stepJustification: null
              },
              methods: {
                initiateCase: async function(e, hireData){
                    let reqData = {
                        onBehalfId: dashboardApp.model.me.id,
                        subject: hireData || {
                            id: dashboardApp.subjectId
                        },
                        action: e.target.textContent,
                        justification: dashboardApp.initJustification
                    }

                    const response = await fetch('/api/case', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(reqData)
                    })

                    await unwrapAlert(response)

                    const responseCases = await fetch('/api/person/cases')
                    const dataCases = await unwrapAlert(responseCases)
                    Vue.set(dashboardApp.model, 'myCases', JSON.parse(dataCases))
                },

                approve: async function(){
                    let reqData = {
                        caseId: dashboardApp.caseId,
                        onBehalfId: dashboardApp.model.me.id,
                        approve: true,
                        justification: dashboardApp.stepJustification
                    }

                    const response = await fetch('/api/case', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(reqData)
                    })

                    await unwrapAlert(response)

                    const responseCases = await fetch('/api/person/cases')
                    const dataCases = await unwrapAlert(responseCases)
                    Vue.set(dashboardApp.model, 'myCases', JSON.parse(dataCases))

                },

                reject: async function(){
                      let reqData = {
                        caseId: dashboardApp.caseId,
                        onBehalfId: dashboardApp.model.me.id,
                        approve: false,
                        justification: dashboardApp.stepJustification
                    }

                    const response = await fetch('/api/case', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(reqData)
                    })

                    await unwrapAlert(response)

                    const responseCases = await fetch('/api/person/cases')
                    const dataCases = await unwrapAlert(responseCases)
                    Vue.set(dashboardApp.model, 'myCases', JSON.parse(dataCases))
                },

                onHire: function(e){
                    let newSubject = {
                        firstName: randomChoice(['Mark', 'Paul', 'Jean']),
                        lastName: randomChoice(['McPherson', 'Diesel', 'Carborator']),
                        role: randomChoice(['IT', 'HR']),
                        age: 20
                    }
                    this.initiateCase(e, newSubject)
                }
              },
              computed: {
                caseButtonDisabled: function(){
                    let cid = this.caseId
                    let mid = this.model.me.id;
                    if(!cid){
                        return true
                    }

                    let sel = this.model.myCases
                        .filter(casee => casee.id == cid)[0]

                    if(sel.done || sel.initiatingPerson.id == mid){
                        return true
                    }
                    if(!caseJustification){
                        return true
                    }
                    return false
                }
              }
            })

            document.getElementById('dashboard-app').classList.remove("hide")
        })()
</script>
</body>
</html>
